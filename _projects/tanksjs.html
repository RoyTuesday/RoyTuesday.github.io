---
permalink: /projects/tanks-js
---
<!DOCTYPE html><html><head><title>Tanks JS</title><meta charset="utf-8" name="viewport" content="width=device-width initial-scale=1"/><meta property="og:title" content="Tanks JS"/><meta name="description" content="A two-player game using the same keyboard; blow up your opponent's tank more times to win, but watch out for ricochet! Based on the game Battle Tanks from Triple Action by Mattel Electronics."/><meta property="og:description" content="A two-player game using the same keyboard; blow up your opponent's tank more times to win, but watch out for ricochet! Based on the game Battle Tanks from Triple Action by Mattel Electronics."/><meta property="og:image" content="{{ "/imgs/tanks-js.jpg" | prepend: site.url }}"/><meta property="og:image:alt" content="Gameplay screenshot of a red and yellow tank squaring off"/><meta property="og:url" content="{{ "/projects/tanks-js" | prepend: site.url }}"/><meta property="og:type" content="website"/><link rel="icon" type="image/png" href="{{ "/imgs/tanks-icon.png" | prepend: site.baseurl }}"/><style type="text/css">@font-face{font-family:'Intellect';src:url('/fonts/intellect.ttf');}body{background:#742;text-align:center;padding:0;margin:0;}.hide{position:absolute!important;padding:0!important;margin:-1px!important;width:1px!important;height:1px!important;left:0!important;top:0!important;right:0!important;bottom:0!important;clip:rect(0 0 0 0);overflow:hidden;}.debug{position:absolute;border:1px solid red;right:0;top:0;}#canvas-wrapper{margin:0 auto;height:100vh;}#canvas{background:#000;width:800px;height:640px;}#canvas table{background:#000;color:#FFF;font:bold 1em/1.2em Helvetica;letter-spacing:1px;border-collapse:collapse;margin:16px auto;}#canvas caption,#canvas th,#canvas td{background:#000;border:1px solid #FFF;padding:1em;}#canvas td{padding:0.5em 1em;}.controls{color:#FFF;font-family:Courier,monospace;text-align:left;text-shadow:1px -1px 1px black,-1px 1px 1px #AAA;padding:0 24px;width:360px;}input[type="checkbox"]{display:none;}input[type="checkbox"]+label{cursor:pointer;display:block;font-size:24px;padding-left:26px;position:relative;margin:0 0 64px;}input[type="checkbox"]+label:before{background:#333;border:2px solid #FFF;border-radius:100%;box-sizing:border-box;content:'';height:18px;left:0;position:absolute;top:5px;width:18px;}input[type="checkbox"]+label:after{background:radial-gradient(circle at center,#F51 25%,#333 100%);border-radius:100%;content:'';height:10px;left:4px;position:absolute;top:9px;transition:transform 200ms;transform:scale(0);width:10px;}input[type="checkbox"]:checked+label:after{transform:scale(1);}.row{font-size:20px;margin:8px auto;text-align:right;width:272px;}.column-2{display:inline-block;padding:0 8px;}.column-2:last-child{text-align:left;width:128px;}</style></head><body><noscript>Please enable JavaScript to play this game</noscript><table id="canvas-wrapper"><tbody><tr><td><canvas id="canvas"width="800"height="640"><table><caption>Sorry, your browser does not meet the minimum requirements for this game</caption><thead><tr><th>Browser</th><th>Oldest Supported Version</th></tr></thead><tbody><tr><td>Internet Explorer</td><td>9.0</td></tr><tr><td>Firefox</td><td>3.6</td></tr><tr><td>Chrome</td><td>4.0</td></tr><tr><td>Safari</td><td>4.0</td></tr><tr><td>Opera</td><td>10.1</td></tr></tbody></table></canvas></td><td class="controls"><input type="checkbox" name="mute" id="mute" checked><label for="mute">Mute Sounds</label><h1>Player 1: <span id="player-1-color"></span></h1><div class="row"><div class="column-2">Forward:</div><div class="column-2">&uarr; (up)</div></div><div class="row"><div class="column-2">Left:</div><div class="column-2">&larr; (left)</div></div><div class="row"><div class="column-2">Right:</div><div class="column-2">&rarr; (right)</div></div><div class="row"><div class="column-2">Backward:</div><div class="column-2">&darr; (down)</div></div><div class="row"><div class="column-2">Fire:</div><div class="column-2">. (period)</div></div><h1>Player 2: <span id="player-2-color"></span></h1><div class="row"><div class="column-2">Forward:</div><div class="column-2">W</div></div><div class="row"><div class="column-2">Left:</div><div class="column-2">A</div></div><div class="row"><div class="column-2">Right:</div><div class="column-2">D</div></div><div class="row"><div class="column-2">Backward:</div><div class="column-2">S</div></div><div class="row"><div class="column-2">Fire:</div><div class="column-2">Tab</div></div></td></tr></tbody></table><canvas id="prerender" class="hide"width="800"height="640"></canvas><canvas id="pretext" class="hide"width="942"height="640"></canvas><canvas id="question"class="hide"width="94"height="80"></canvas></body><script type="text/javascript">const LEVELS=[[0,0,0,1,1,1,1,1,3,0,0,0,2,2,0,1,1,1,1,1,0,0,0,1,1,1,1,1,3,0,0,0,2,2,0,1,3,3,3,3,0,0,0,1,1,1,1,1,3,0,0,0,2,2,0,1,0,1,1,1,0,0,0,0,1,1,1,1,1,0,0,0,2,2,0,1,3,0,1,1,0,0,0,0,0,1,1,1,1,0,0,0,2,2,0,1,3,0,1,1,0,0,0,0,0,0,0,1,1,0,0,0,2,2,0,1,3,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,2,2,0,1,3,1,1,1,1,1,0,0,0,0,0,0,0,0,0,2,2,2,0,1,3,1,1,1,1,1,1,1,1,1,0,0,0,0,2,2,2,0,0,1,1,1,1,1,3,3,3,3,3,3,0,0,0,2,2,2,0,0,1,0,1,1,1,1,0,0,0,0,0,0,0,0,0,2,2,0,0,1,1,1,0,1,1,1,0,0,0,0,0,0,0,0,0,2,2,0,1,1,3,3,3,1,1,1,0,0,0,0,0,0,0,0,0,2,2,0,1,1,0,1,1,1,1,1,0,0,0,0,0,3,0,0,2,2,0,0,1,1,0,1,1,1,1,1,0,0,0,0,1,3,0,0,2,2,0,1,1,1,3,0,1,1,1,1,0,0,0,1,1,3,0,0,2,2,0,1,1,1,3,0,1,1,1,1,0,0,0,1,1,3,3,2,2,3,3,3,1,1,3,1,1,1,0,1,0,0,1,1,0,0,0,2,2,0,0,0,1,1,3,1,1,1,0,1,0,0,1,1,0,0,0,2,2,0,0,0,1,1,1,1,1,1,1,1,0,0,1,1,0,0,0,2,2,0,0,1,1,1,1,1,1,1,1,1],[0,0,0,1,1,1,0,0,0,1,1,2,2,2,2,2,2,2,2,2,0,0,1,1,1,1,1,0,0,1,1,2,2,2,2,2,2,2,2,2,0,1,1,1,1,1,0,0,0,1,1,1,2,2,2,2,2,2,2,2,1,1,1,1,1,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,1,1,1,1,1,1,0,0,0,0,1,1,1,2,2,2,2,2,2,2,1,1,1,1,1,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,0,0,1,1,0,0,0,0,0,0,0,1,1,1,2,2,2,2,2,2,0,0,0,0,0,0,0,0,3,0,0,0,1,1,1,1,2,2,2,2,0,0,0,0,0,0,0,0,3,0,0,0,0,0,1,1,1,1,1,2,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,1,1,1,1,0,0,0,3,3,3,3,3,3,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,3,3,3,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,3,0,0,0,0,0,0,0,2,2,1,1,1,1,1,1,0,0,0,0,3,0,0,0,0,0,0,0,2,2,2,2,2,1,1,1,1,0,0,0,3,0,0,0,1,1,1,0,2,2,2,2,2,2,1,1,1,0,0,0,3,0,0,1,0,1,1,1,2,2,2,2,2,2,2,1,1,1,0,0,3,0,0,1,1,1,1,1,2,2,2,2,2,2,2,1,1,1,0,0,0,0,1,1,1,1,1,0,2,2,2,2,2,2,2,2,1,1,0,0,0,0,1,1,1,1,1,0,2,2,2,2,2,2,2,2,1,1,1,0,0,0,1,1,1,1,0,0],[0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,3,3,1,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,1,1,1,0,0,0,0,1,1,1,1,1,1,1,3,3,0,0,0,1,1,1,0,0,2,2,0,0,3,1,1,1,1,1,1,3,0,0,1,1,1,0,0,2,2,2,2,2,3,3,3,3,1,1,1,3,1,0,1,1,0,0,0,2,2,2,2,2,2,2,2,3,1,1,1,3,1,1,1,0,0,0,2,2,2,2,2,2,2,2,2,2,2,1,1,3,1,1,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,2,0,1,1,1,0,0,0,0,0,2,2,2,2,2,2,2,2,2,2,2,0,1,1,1,0,0,0,0,0,0,2,2,2,2,2,2,2,2,2,0,0,1,1,1,0,0,3,3,0,0,3,3,3,3,2,2,2,0,0,0,0,1,1,1,0,0,0,3,0,0,1,1,1,3,0,0,0,0,0,0,0,1,1,1,0,0,0,3,0,0,0,0,1,3,0,0,0,0,0,0,0,1,1,1,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,3,3,3,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1],[0,0,0,0,0,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,1,3,1,1,1,1,1,0,0,1,0,0,1,1,1,1,1,3,1,1,1,3,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,3,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,0,0,3,0,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,0,3,3,3,3,3,3,3,3,3,3,0,1,1,1,1,1,1,1,1,1,3,0,0,0,0,0,0,0,0,3,3,3,3,1,1,3,3,1,1,1,3,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,1,1,0,3,0,0,3,0,0,3,0,0,0,1,1,1,1,1,1,1,1,1,1,3,0,0,3,0,0,3,0,0,3,1,1,1,1,1,1,1,1,1,1,3,0,0,3,0,0,3,0,0,3,0,1,1,1,1,1,1,1,1,1,0,0,0,3,0,0,3,0,0,3,1,1,1,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,3,1,1,1,3,3,1,1,3,3,3,3,0,0,0,0,0,0,0,0,3,0,1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3,3,0,1,1,1,1,1,1,1,1,1,1,0,1,0,1,1,3,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,3,1,1,1,3,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,3,1,1,2,2,2,1,1,1,0,0,0,0,1,1,1,1,1,1,1,3,1,2,2,2,2,2,1,1,0,0,0,0],[2,2,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,0,0,1,1,1,1,1,1,1,1,1,1,3,1,1,1,1,1,3,2,0,0,1,1,1,1,1,1,1,1,1,1,3,1,1,1,1,1,3,3,1,1,3,3,3,3,3,3,3,3,1,1,3,1,1,3,1,1,3,3,1,1,3,1,1,3,1,1,1,1,1,1,3,1,1,3,1,1,3,3,1,1,3,1,1,3,1,1,1,1,1,1,1,1,1,3,1,1,3,3,1,1,3,1,1,3,1,1,1,1,1,1,1,1,1,3,1,1,3,3,1,1,3,1,1,3,1,1,3,3,3,3,3,1,1,3,1,1,3,3,1,1,1,1,1,3,1,1,1,1,1,1,3,1,1,3,1,1,3,3,1,1,1,1,1,3,1,1,1,1,1,1,3,1,1,3,1,1,3,3,1,1,3,3,3,3,3,1,1,3,3,3,3,3,3,3,3,3,3,3,1,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,1,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,1,1,3,1,1,3,3,3,3,3,3,1,1,3,3,3,1,1,3,3,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,3,1,1,3,3,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,3,1,1,3,3,3,3,3,1,1,3,3,3,1,1,3,3,3,3,3,3,1,1,3,3,1,1,1,1,1,3,1,1,1,1,1,1,1,1,1,1,0,0,2,3,1,1,1,1,1,3,1,1,1,1,1,1,1,1,1,1,0,0,2,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2],[1,1,1,3,0,3,1,1,1,0,0,0,4,4,5,5,5,5,5,5,0,0,0,0,0,1,1,0,0,0,0,0,1,1,0,0,0,4,4,5,5,5,5,5,5,0,0,0,0,0,1,0,0,0,0,0,1,1,1,0,0,0,0,4,4,5,5,5,5,5,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,4,4,4,5,5,5,5,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,4,4,4,5,5,5,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,4,4,4,4,5,0,0,0,0,0,1,1,0,0,1,1,1,1,3,1,1,0,0,0,0,0,0,4,4,4,3,0,0,0,0,1,1,1,1,1,1,1,1,3,3,1,1,0,0,0,0,0,0,0,4,3,0,0,0,0,1,1,1,1,1,1,1,1,3,1,1,1,1,1,0,0,0,0,0,0,3,0,0,0,0,1,1,1,1,1,1,1,1,3,1,1,1,3,1,1,1,0,0,0,0,3,0,0,0,0,1,1,1,1,3,3,3,3,3,1,1,1,3,1,1,1,1,1,1,0,3,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,3,3,3,1,1,1,1,3,3,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,3,1,1,1,1,1,1,1,0,0,0,0,0,2,0,0,0,3,3,0,0,1,1,1,1,3,1,1,1,1,1,1,3,3,0,0,0,0,2,2,2,0,0,3,0,0,0,1,1,1,3,1,1,1,1,1,1,0,3,0,0,0,0,2,2,2,2,2,0,0,3,0,1,1,1,3,1,1,1,1,1,0,0,3,0,0,0,0,2,2,2,2,2,2,0,3,3,0,1,3,3,1,1,1,0,0,0,0,3,0,0,0,0,2,2,2,2,2,2,0,0,0,0,1,1,1,1,1,0,0,0,0,1,3,0,0,0,0,2,2,2,2,2,2,2,0,0,0,1,1,1,1,1,0,0,0,0,1,3,0,0,0,0,2,2,2,2,2,2,2,0,0,0,0,1,1,1,0,0,0,0,1,1,3,0,0,0,0],[4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,0,0,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,4,0,0,0,0,0,0,4,4,4,4,4,5,5,5,4,4,4,5,5,4,4,0,0,0,0,0,0,0,0,0,4,4,4,4,4,2,2,4,5,5,4,0,0,0,0,0,4,4,4,0,0,0,0,1,1,2,4,4,5,5,4,0,0,4,4,0,0,0,0,0,4,4,0,0,1,4,4,5,5,5,4,0,0,4,4,0,0,4,4,4,4,1,0,0,0,4,5,5,5,5,4,0,0,4,0,0,4,4,1,1,1,1,4,4,0,4,4,5,5,5,4,0,0,0,0,4,4,1,1,1,1,1,4,0,0,0,4,5,5,5,4,4,0,0,0,4,1,1,1,1,1,4,4,0,0,0,4,4,5,5,5,4,0,0,4,4,1,1,1,1,1,4,0,0,0,0,0,4,5,5,5,4,0,0,4,1,1,1,1,1,4,4,0,0,0,0,0,4,5,5,5,4,4,0,4,1,1,1,1,4,4,0,0,4,0,0,4,4,5,5,5,5,4,0,0,1,4,4,4,4,0,0,4,4,0,0,4,5,5,5,5,4,4,0,0,0,4,0,0,0,0,0,4,4,0,0,4,5,5,5,4,4,1,0,0,0,0,0,0,0,0,4,4,4,0,0,4,4,5,5,4,1,1,1,4,4,4,4,0,0,0,0,0,0,0,0,0,4,4,5,4,1,1,4,4,5,5,4,4,4,4,4,0,0,0,0,0,0,4,5,4,4,4,4,5,5,5,5,5,5,5,4,4,4,4,4,0,0,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,4,4]];const RANDOM=LEVELS.length;var level=LEVELS[0];var levelOption=0;var levelNum=0;var bubbles=[];function getTileIndex(x,y,levelNum){return(x/32>>0)+(levelNum==5?25:20)*(y/32>>0)}function generateBubbles(level,levelNum){let bubbles=[];let skipTiles=levelNum==5;for(let i=0;i<400;i++){if(level[i]==5){bubbles.push({x:32*(i%(skipTiles?25:20)),y:32*(i/(skipTiles?25:20)>>0),step:Math.random()*120>>0})}}return bubbles}var scene="loading";var round=1;var roundLimit=5;var cpuOption=0;var cpuSkill=0;var menu={delay:0,showLeft:1,showRight:1};var optionRow=0;const PALETTE=["#951","#791","#158","#722","#333","#C42"];const paletteNames=["Blue/Green","Red/Yellow","Green/Blue","Yellow/Red"];var paletteOption=0;const playerColors=[["#0AF","#0D2"],["#E04","#DE2"],["#0D2","#0AF"],["#DE2","#E04"]];var score=[0,0];var gKeys=[{},{}];var players=[{x:64,y:64,r:0,life:60,delay:0,shells:0},{x:576,y:576,r:3.14,life:60,delay:0,shells:0}];var trails=[[],[]];var cpuTargets=[{x:-1,y:-1},{x:-1,y:-1}];function prerenderTitle(){var context=document.getElementById("prerender").getContext("2d");context.clearRect(0,0,800,640);context.fillStyle="#49C";context.fillRect(0,0,800,640);context.fillStyle="#FFF";context.fillRect(56,48,16,48);context.fillStyle="#FF0";context.fillRect(140,48,16,48);context.fillStyle="#0F0";context.fillRect(224,48,16,48);context.fillStyle="#0A0";context.fillRect(308,48,16,48);context.fillStyle="#FFF";context.fillRect(392,48,16,48);context.fillStyle="#CCA";context.fillRect(476,48,16,48);context.fillStyle="#F00";context.fillRect(560,48,16,48);context.fillStyle="#00F";context.fillRect(644,48,16,48);context.fillStyle="#000";context.fillRect(728,48,16,48);var text=document.getElementById("pretext");var textContext=text.getContext("2d");textContext.fillStyle="#FFF";textContext.font="48px Intellect";textContext.textAlign="center";textContext.fillText("Peter  Wood",471,214);textContext.fillText("presents",471,258);textContext.fillText("TANKS  JS",471,416);textContext.fillText("Cpr  @  2017  PNW",471,592);context.drawImage(text,0,0,942,640,0,0,800,640)}function renderTank(context,tank,color){context.fillStyle=color;context.beginPath();context.moveTo(tank.x+18*Math.cos(tank.r+.17),tank.y+18*Math.sin(tank.r+.17));context.lineTo(tank.x+9*Math.cos(tank.r+.34),tank.y+9*Math.sin(tank.r+.34));context.lineTo(tank.x+12*Math.cos(tank.r+1),tank.y+12*Math.sin(tank.r+1));context.lineTo(tank.x-14*Math.cos(tank.r-.79),tank.y-14*Math.sin(tank.r-.79));context.lineTo(tank.x-14*Math.cos(tank.r+.79),tank.y-14*Math.sin(tank.r+.79));context.lineTo(tank.x+12*Math.cos(tank.r-1),tank.y+12*Math.sin(tank.r-1));context.lineTo(tank.x+9*Math.cos(tank.r-.34),tank.y+9*Math.sin(tank.r-.34));context.lineTo(tank.x+18*Math.cos(tank.r-.17),tank.y+18*Math.sin(tank.r-.17));context.closePath();context.fill()}function renderLevelPreview(level){var context=document.getElementById("prerender").getContext("2d");if(level){let skipTiles=level.length>400;let skipAmount=0;for(let i=0;i<400;i++){if(skipTiles&&i>0&&i%20==0){skipAmount+=5}context.fillStyle=PALETTE[level[i+skipAmount]];context.fillRect(520+4*(i%20),450+4*(i/20>>0),4,4)}}else{context.drawImage(document.getElementById("question"),0,0,94,80,520,450,80,80)}}function prerenderMenu(roundLimit,option,cpuOption,cpuSkill,levelOption){var context=document.getElementById("prerender").getContext("2d");context.strokeStyle="#FFF";context.lineWidth=2;var text=document.getElementById("pretext");var textContext=text.getContext("2d");let cpuPlayer;switch(cpuOption){case 0:cpuPlayer="none";break;case 1:cpuPlayer="Player 1";break;case 2:cpuPlayer="Player 2";break;case 3:cpuPlayer="Both";break}let levelName=levelOption==RANDOM?"random":levelOption+1;let level=LEVELS[levelOption];context.clearRect(0,0,800,640);textContext.clearRect(0,0,942,760);textContext.font="32px Intellect";textContext.textAlign="center";textContext.fillText("Press spacebar to start",471,584);textContext.font="40px Intellect";textContext.textAlign="right";textContext.fillText("Rounds:",377,60);textContext.fillText("Colors:",377,150);textContext.fillText("CPU:",377,240);textContext.fillText("CPU Skill:",377,330);textContext.fillText("Level:",377,420);textContext.textAlign="center";textContext.fillText(roundLimit,664,60);textContext.fillText(paletteNames[option],664,150);textContext.fillText(cpuPlayer,664,240);textContext.fillText(cpuSkill+1,664,330);textContext.fillText(levelName,664,420);context.drawImage(text,0,0,942,640,0,0,800,640);renderTank(context,{x:300,y:470,r:0},playerColors[option][0]);renderTank(context,{x:340,y:510,r:3.14},playerColors[option][1]);renderLevelPreview(level)}function prerenderScore(score,round,roundLimit){var context=document.getElementById("prerender").getContext("2d");context.clearRect(640,0,160,640);var text=document.getElementById("pretext");var textContext=text.getContext("2d");textContext.clearRect(0,0,942,640);textContext.font="24px Intellect";textContext.textAlign="left";textContext.fillText("Round",768,32);textContext.fillText("of",800,64);textContext.fillText("Level",768,128);textContext.fillText(levelOption==RANDOM?"random":levelOption,800,160);textContext.fillText("Player 1",768,248);textContext.fillText(score[0],800,280);textContext.fillText("Player 2",768,352);textContext.fillText(score[1],800,384);textContext.textAlign="right";textContext.fillText(round,910,32);textContext.fillText(roundLimit,910,64);context.drawImage(text,0,0,942,640,0,0,800,640)}function prerenderLevel(level,levelNum,score,round,roundLimit){var context=document.getElementById("prerender").getContext("2d");context.clearRect(0,0,800,640);let skipTiles=levelNum==5;let skipAmount=0;for(let i=0;i<400;i++){if(skipTiles&&i>0&&i%20==0){skipAmount+=5}context.fillStyle=PALETTE[level[i+skipAmount]];context.fillRect(32*(i%20),32*(i/20>>0),32,32)}prerenderScore(score,round,roundLimit)}function prerenderFinal(roundLimit,score){var context=document.getElementById("prerender").getContext("2d");context.clearRect(0,0,800,640);var text=document.getElementById("pretext");var textContext=text.getContext("2d");textContext.clearRect(0,0,942,640);textContext.font="72px Intellect";textContext.textAlign="center";textContext.fillText("Final Score",471,96);textContext.font="32px Intellect";textContext.fillText("Press spacebar for new game",471,584);textContext.font="48px Intellect";textContext.textAlign="right";textContext.fillText(roundLimit,432,176);textContext.fillText("Player 1:",546,352);textContext.fillText("Player 2:",546,448);textContext.textAlign="left";textContext.fillText(roundLimit>1?"Rounds":"Round",451,176);textContext.fillText(score[0],584,352);textContext.fillText(score[1],584,448);context.drawImage(text,0,0,942,640,0,0,800,640)}var shells=[];function Shell(p,n){this.x=p.x+18*Math.cos(p.r);this.y=p.y+18*Math.sin(p.r);this.r=p.r;this.n=n;return this}Shell.prototype.life=128;function moveShell(players,shell,levelNum){let r=0;for(let p=0;p<8;p++){let cos=Math.cos(shell.r);let sin=Math.sin(shell.r);shell.x+=cos;shell.y+=sin;if(shell.x<=2||players[shell.n].x<640&&shell.x>=638||shell.x>=798){shell.r=Math.atan2(sin,-cos);if(!r)r=1}if(shell.y<=2||shell.y>=638){shell.r=Math.atan2(-sin,cos);if(!r)r=1}let c=getTileIndex(shell.x,shell.y,levelNum);if(level[c]&&level[c]>2&&level[c]<5){let fromX=16-Math.abs(shell.x%32-16)>>0;let fromY=16-Math.abs(shell.y%32-16)>>0;if(fromX==fromY){shell.r=Math.atan2(-sin,-cos);if(!r)r=1}else if(fromX<fromY){shell.r=Math.atan2(sin,-cos);if(!r)r=1}else{shell.r=Math.atan2(-sin,cos);if(!r)r=1}}}shell.life--;return r}function shellCollidesWithPlayer(shell,player){return player.life==60&&Math.sqrt(Math.pow(player.x-shell.x,2)+Math.pow(player.y-shell.y,2))<16}var audio;if(typeof AudioContext!=="undefined"){audio=new AudioContext}else if(typeof webkitAudioContext!=="undefined"){audio=new webkitAudioContext}else{console.error("AudioContext not available")}var mute=window.localStorage.getItem("mute")=="1";if(mute!=null){document.getElementById("mute").checked=mute;if(audio){audio.mute=mute}}else{toggleMute()}function toggleMute(){if(audio){audio.mute=document.getElementById("mute").checked;window.localStorage.setItem("mute",audio.mute?1:0);if(!audio.mute){playTone(0,.2)}else{if(players[0].treads){players[0].treads=stopSound(players[0].treads.o,players[0].treads.g)}if(players[1].treads){players[1].treads=stopSound(players[1].treads.o,players[1].treads.g)}if(players[0].turn){players[0].turn=stopSound(players[0].turn.o,players[0].turn.g)}if(players[1].turn){players[1].turn=stopSound(players[1].turn.o,players[1].turn.g)}}}}document.getElementById("mute").addEventListener("change",toggleMute);function getKey(event){if(typeof event.key=="string"){return event.key}else{switch(event.keyCode){case 9:return"Tab";break;case 32:return" ";break;case 37:return"ArrowLeft";break;case 38:return"ArrowUp";break;case 39:return"ArrowRight";break;case 40:return"ArrowDown";break;case 97:return"a";break;case 100:return"d";break;case 115:return"s";break;case 119:return"w";break;case 190:return".";break}}}function hkd(e){if(!e.altKey&&!e.ctrlKey&&!e.metaKey){e.preventDefault()}if(!e.repeat){let key=getKey(e);switch(scene){case"title":scene="menu";context.fillStyle="#FFF";prerenderMenu(roundLimit,paletteOption,cpuOption,cpuSkill,levelOption);break;case"menu":case"final":switch(key){case"ArrowLeft":if(typeof menu.col=="undefined"){menu.col=-1}else{menu.col--}break;case"ArrowRight":if(typeof menu.col=="undefined"){menu.col=1}else{menu.col++}break;case"ArrowUp":if(typeof menu.row=="undefined"){menu.row=-1}else{menu.row--}break;case"ArrowDown":if(typeof menu.row=="undefined"){menu.row=1}else{menu.row++}break;case" ":menu.start=1;break}break;case"game":if(cpuOption<3){switch(key){case"ArrowLeft":if(cpuOption!=1){if(typeof gKeys[0].turn=="undefined"){gKeys[0].turn=-1}else{gKeys[0].turn--}}break;case"ArrowRight":if(cpuOption!=1){if(typeof gKeys[0].turn=="undefined"){gKeys[0].turn=1}else{gKeys[0].turn++}}break;case"ArrowUp":if(cpuOption!=1){if(typeof gKeys[0].move=="undefined"){gKeys[0].move=1}else{gKeys[0].move++}}break;case"ArrowDown":if(cpuOption!=1){if(typeof gKeys[0].move=="undefined"){gKeys[0].move=-.5}else{gKeys[0].move-=.5}}break;case".":if(cpuOption!=1){gKeys[0].fire=1};break;case"a":if(cpuOption<2){if(typeof gKeys[1].turn=="undefined"){gKeys[1].turn=-1}else{gKeys[1].turn--}}break;case"d":if(cpuOption<2){if(typeof gKeys[1].turn=="undefined"){gKeys[1].turn=1}else{gKeys[1].turn++}}break;case"w":if(cpuOption<2){if(typeof gKeys[1].move=="undefined"){gKeys[1].move=1}else{gKeys[1].move++}}break;case"s":if(cpuOption<2){if(typeof gKeys[1].move=="undefined"){gKeys[1].move=-.5}else{gKeys[1].move-=.5}}break;case"Tab":if(cpuOption<2){gKeys[1].fire=1}break}}break}}}function hku(e){let key=getKey(e);switch(scene){case"menu":case"final":switch(key){case"ArrowLeft":if(typeof menu.col!="undefined"){menu.col++}break;case"ArrowRight":if(typeof menu.col!="undefined"){menu.col--}break;case"ArrowUp":if(typeof menu.row!="undefined"){menu.row++}break;case"ArrowDown":if(typeof menu.row!="undefined"){menu.row--}break;case" ":menu.start=0;break}break;case"game":switch(key){case"ArrowLeft":if(typeof gKeys[0].turn!="undefined"){gKeys[0].turn++}break;case"ArrowRight":if(typeof gKeys[0].turn!="undefined"){gKeys[0].turn--}break;case"ArrowUp":if(typeof gKeys[0].move!="undefined"){gKeys[0].move--}break;case"ArrowDown":if(typeof gKeys[0].move!="undefined"){gKeys[0].move+=.5}break;case".":gKeys[0].fire=0;break;case"a":if(typeof gKeys[1].turn!="undefined"){gKeys[1].turn++}break;case"d":if(typeof gKeys[1].turn!="undefined"){gKeys[1].turn--}break;case"w":if(typeof gKeys[1].move!="undefined"){gKeys[1].move--}break;case"s":if(typeof gKeys[1].move!="undefined"){gKeys[1].move+=.5}break;case"Tab":gKeys[1].fire=0;break}break}}document.addEventListener("keydown",hkd);document.addEventListener("keyup",hku);function calculateGain(f,type,sustain){var gainMod;switch(type){case"sine":gainMod=sustain?4:2;break;case"triangle":gainMod=sustain?5:2;break;case"sawtooth":gainMod=sustain?20:5;break;case"square":gainMod=sustain?22:6;break}return Math.pow(1.05,f/-20)/gainMod}function stopSound(o,g){if(!audio||!o||!g){return null}let t=audio.currentTime;g.gain.setValueAtTime(g.gain.value,t);g.gain.linearRampToValueAtTime(0,t+.3);o.stop(t+.4);return null}function startTreadsSound(p){if(!audio||audio.mute){return{o:0,g:0}}let t=audio.currentTime;var o=audio.createOscillator();var g=audio.createGain();o.connect(g);g.connect(audio.destination);let f=p==0?110:74;o.frequency.value=f;o.type="triangle";let n=calculateGain(f,"triangle",true);g.gain.value=n;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(n,t+.1);o.start(t);return{o:o,g:g}}function startTurnSound(p){if(!audio||audio.mute){return{o:0,g:0}}let t=audio.currentTime;var o=audio.createOscillator();var g=audio.createGain();o.connect(g);g.connect(audio.destination);let f=p==0?220:148;o.frequency.value=f;o.type="triangle";let n=calculateGain(f,"triangle",true);g.gain.value=n;g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(n,t+.1);o.start(t);return{o:o,g:g}}function playTone(s,d,f,w){if(!audio||audio.mute){return 0}let t=audio.currentTime+s;var o=audio.createOscillator();var g=audio.createGain();o.connect(g);g.connect(audio.destination);if(f){o.frequency.value=f}else{f=o.frequency.value}if(w){o.type=w}else{w=o.type}let n=calculateGain(f,w);g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(n,t+.02);g.gain.linearRampToValueAtTime(0,t+d);o.start(t);o.stop(t+d)}function playFireSound(p){if(!audio||audio.mute){return 0}let t=audio.currentTime;var o=audio.createOscillator();var g=audio.createGain();o.connect(g);g.connect(audio.destination);let f=p==0?55:37;o.frequency.value=f;o.type="square";g.gain.setValueAtTime(calculateGain(f,"square"),t);g.gain.linearRampToValueAtTime(0,t+.2);o.start(t);o.stop(t+.2)}function playRicochetSound(p){if(!audio||audio.mute){return 0}let t=audio.currentTime;var o=audio.createOscillator();var g=audio.createGain();o.connect(g);g.connect(audio.destination);let f=p==0?220:148;o.frequency.value=f;o.type="square";g.gain.setValueAtTime(calculateGain(f,"square"),t);g.gain.linearRampToValueAtTime(0,t+.2);o.start(t);o.stop(t+.2)}function playExplodeSound(p){if(!audio||audio.mute){return 0}var t=audio.currentTime;var o=audio.createOscillator();var g=audio.createGain();o.connect(g);g.connect(audio.destination);let f=p==0?220:148;o.type="square";let n=calculateGain(f,"square");g.gain.setValueAtTime(n,t);g.gain.setValueAtTime(n,t+.3);g.gain.linearRampToValueAtTime(0,t+.4);o.frequency.setValueAtTime(f,t);o.frequency.exponentialRampToValueAtTime(f/4,t+.4);o.start(t);o.stop(t+.4)}var context=document.getElementById("canvas").getContext("2d");context.camera={x:0,y:0};var prerender=document.getElementById("prerender");let question=document.getElementById("question").getContext("2d");question.strokeStyle="#FFF";question.lineWidth=6;question.strokeRect(0,0,94,80);question.fillStyle="#FFF";question.font="32px Intellect";question.textAlign="center";let static=context.createImageData(800,640);function step(timestamp){context.clearRect(0,0,800,640);switch(scene){case"loading":for(let p=0;p<32e3;p++){let value=255*Math.random()>>0;let i=16*(p%200)+12800*(p/200>>0);static.data[i]=value;static.data[i+1]=value;static.data[i+2]=value;static.data[i+4]=value;static.data[i+5]=value;static.data[i+6]=value;static.data[i+8]=value;static.data[i+9]=value;static.data[i+10]=value;static.data[i+12]=value;static.data[i+13]=value;static.data[i+14]=value;static.data[i+3200]=value;static.data[i+3201]=value;static.data[i+3202]=value;static.data[i+3204]=value;static.data[i+3205]=value;static.data[i+3206]=value;static.data[i+3208]=value;static.data[i+3209]=value;static.data[i+3210]=value;static.data[i+3212]=value;static.data[i+3213]=value;static.data[i+3214]=value;static.data[i+6400]=value;static.data[i+6401]=value;static.data[i+6402]=value;static.data[i+6404]=value;static.data[i+6405]=value;static.data[i+6406]=value;static.data[i+6408]=value;static.data[i+6409]=value;static.data[i+6410]=value;static.data[i+6412]=value;static.data[i+6413]=value;static.data[i+6414]=value;static.data[i+9600]=value;static.data[i+9601]=value;static.data[i+9602]=value;static.data[i+9604]=value;static.data[i+9605]=value;static.data[i+9606]=value;static.data[i+9608]=value;static.data[i+9609]=value;static.data[i+9610]=value;static.data[i+9612]=value;static.data[i+9613]=value;static.data[i+9614]=value;if(static.data[i+3]<255){static.data[i+3]=255;static.data[i+7]=255;static.data[i+11]=255;static.data[i+15]=255;static.data[i+3203]=255;static.data[i+3207]=255;static.data[i+3211]=255;static.data[i+3215]=255;static.data[i+6403]=255;static.data[i+6407]=255;static.data[i+6411]=255;static.data[i+6415]=255;static.data[i+9603]=255;static.data[i+9607]=255;static.data[i+9611]=255;static.data[i+9615]=255}}context.putImageData(static,0,0);context.fillStyle="#000";context.fillRect(12,12,56,16);context.fillRect(12,20,24,56);context.fillRect(12,68,56,16);context.fillRect(76,12,24,72);context.fillRect(92,36,40,16);context.fillRect(108,12,24,72);context.fillRect(156,12,56,16);context.fillRect(188,20,24,56);context.fillRect(172,36,24,16);context.fillRect(156,68,56,16);context.fillStyle="#0F0";context.fillRect(16,16,48,8);context.fillRect(16,24,16,48);context.fillRect(16,72,48,8);context.fillRect(80,16,16,64);context.fillRect(96,40,32,8);context.fillRect(112,16,16,64);context.fillRect(160,16,48,8);context.fillRect(192,24,16,48);context.fillRect(176,40,16,8);context.fillRect(160,72,48,8);break;case"title":context.drawImage(prerender,0,0);break;case"menu":if(menu.delay==0){if(menu.start){scene="game";menu.start=0;if(levelOption==RANDOM){level=LEVELS[Math.random()*RANDOM>>0]}else{level=LEVELS[levelOption]}prerenderLevel(level,levelNum,score,round,roundLimit);bubbles=generateBubbles(level,levelNum)}else{if(menu.row){if(menu.row<0&&optionRow>0){optionRow--}if(menu.row>0&&optionRow<4){optionRow++}playTone(0,.2,120,"triangle");playTone(0,.2,180,"triangle")}if(menu.col){switch(optionRow){case 0:if(menu.col<0&&roundLimit>1){roundLimit-=2}if(menu.col>0&&roundLimit<15){roundLimit+=2}let bass=100*(1+roundLimit/15);playTone(0,.2,bass,"triangle");playTone(0,.2,1.33*bass,"triangle");break;case 1:if(menu.col<0&&paletteOption>0){paletteOption--}if(menu.col>0&&paletteOption<3){paletteOption++}playTone(0,.2,150,"triangle");playTone(0,.2,200,"triangle");break;case 2:if(menu.col<0&&cpuOption>0){cpuOption--}if(menu.col>0&&cpuOption<3){cpuOption++}playTone(0,.2,150,"triangle");playTone(0,.2,200,"triangle");break;case 3:if(menu.col<0&&cpuSkill>0){cpuSkill--}if(menu.col>0&&cpuSkill<3){cpuSkill++}playTone(0,.2,150,"triangle");playTone(0,.2,200,"triangle");break;case 4:if(menu.col<0&&levelOption>0){levelOption--}if(menu.col>0&&levelOption<RANDOM){levelOption++}if(levelOption<RANDOM){levelNum=RANDOM*Math.random()>>0}else{levelNum=levelOption}playTone(0,.2,150,"triangle");playTone(0,.2,200,"triangle");break}prerenderMenu(roundLimit,paletteOption,cpuOption,cpuSkill,levelOption)}if(menu.row||menu.col){switch(optionRow){case 0:if(roundLimit==1){if(menu.showLeft){menu.showLeft=0}}else if(!menu.showLeft){menu.showLeft=1}if(roundLimit==15){if(menu.showRight){menu.showRight=0}}else if(!menu.showRight){menu.showRight=1}break;case 1:if(paletteOption==0){if(menu.showLeft){menu.showLeft=0}}else if(!menu.showLeft){menu.showLeft=1}if(paletteOption==3){if(menu.showRight){menu.showRight=0}}else if(!menu.showRight){menu.showRight=1}break;case 2:if(cpuOption==0){if(menu.showLeft){menu.showLeft=0}}else if(!menu.showLeft){menu.showLeft=1}if(cpuOption==3){if(menu.showRight){menu.showRight=0}}else if(!menu.showRight){menu.showRight=1}break;case 3:if(cpuSkill==0){if(menu.showLeft){menu.showLeft=0}}else if(!menu.showLeft){menu.showLeft=1}if(cpuSkill==3){if(menu.showRight){menu.showRight=0}}else if(!menu.showRight){menu.showRight=1}break;case 4:if(levelOption==0){if(menu.showLeft){menu.showLeft=0}}else if(!menu.showLeft){menu.showLeft=1}if(levelOption==RANDOM){if(menu.showRight){menu.showRight=0}}else if(!menu.showRight){menu.showRight=1}break}menu.delay=20}}}context.drawImage(prerender,0,0);var rowY=45+90*optionRow;if(menu.showLeft){context.beginPath();context.moveTo(360,rowY);context.lineTo(400,rowY-30);context.lineTo(400,rowY+30);context.closePath();context.fill()}if(menu.showRight){context.beginPath();context.moveTo(760,rowY);context.lineTo(720,rowY-30);context.lineTo(720,rowY+30);context.closePath();context.fill()}if(menu.delay>0){menu.delay--}break;case"final":context.drawImage(prerender,0,0);if(menu.start){prerenderMenu(roundLimit,paletteOption,cpuOption,cpuSkill,levelOption);context.fillStyle="#FFF";scene="menu";menu.start=0;score=[0,0]}break;case"game":for(let i=0;i<2;i++){let p=players[i];let other=players[i^1];if(cpuOption>0){if(cpuOption==3||cpuOption==i+1){if(gKeys[i].fire){gKeys[i].fire=false}let turn=0;switch(cpuSkill){case 0:let xDist=other.x-p.x;let yDist=other.y-p.y;let dist=Math.sqrt(Math.pow(xDist,2)+Math.pow(yDist,2));let rad=Math.atan2(yDist,xDist);if(rad<0){rad+=6.28}else if(rad>=6.28){rad-=6.28}let rDist=rad-p.r;if(dist<160){if(gKeys[i].move||cpuTargets[i].x>-1||cpuTargets[i].y>-1){gKeys[i].move=0;cpuTargets[i].x=-1;cpuTargets[i].y=-1}if(other.life==60&&p.delay==0){let targetHit;let collision=-2;let shell=new Shell(p,i);while(collision<cpuSkill&&!targetHit&&shell.life>0){if(moveShell(players,shell,levelNum)){collision++}if(shellCollidesWithPlayer(shell,other)){targetHit=1}else if(shellCollidesWithPlayer(shell,p)){targetHit=-1}}if(targetHit>0){gKeys[i].fire=true}}if(rDist>3.14){turn=-1}else if(rDist<-3.14){turn=1}else if(rDist>.05){turn=1}else if(rDist<-.05){turn=-1}}else{let targetXDist=cpuTargets[i].x-p.x;let targetYDist=cpuTargets[i].y-p.y;if(targetXDist>-1&&targetXDist<1&&targetYDist>-1&&targetYDist<1||cpuTargets[i].x<0&&cpuTargets[i].y<0){if(gKeys[i].move){gKeys[i].move=0}let width=levelNum==5?25:20;let index=getTileIndex(p.x,p.y,levelNum);let wes=level[index-1];let eas=level[index+1];let nor=level[index-width];let sou=level[index+width];let nWe=level[index-1-width];let nEa=level[index+1-width];let sWe=level[index-1+width];let sEa=level[index+1+width];let adjacents=[];if(typeof wes=="number"&&wes!=3&&wes!=4&&index%width>0){adjacents.push(index-1)}if(typeof eas=="number"&&eas!=3&&eas!=4&&index%width<width-1){adjacents.push(index+1)}if(typeof nor=="number"&&nor!=3&&nor!=4&&index/width>=1){adjacents.push(index-width)}if(typeof sou=="number"&&sou!=3&&sou!=4&&index/width<20*(width-1)){adjacents.push(index+width)}if(typeof nWe=="number"&&nWe!=3&&nWe!=4&&(index-1)%width>0){adjacents.push(index-width-1)}if(typeof nEa=="number"&&nEa!=3&&nEa!=4&&(index+1)%width<width-1){adjacents.push(index-width+1)}if(typeof sWe=="number"&&sWe!=3&&sWe!=4&&(index-1)/width>=1){adjacents.push(index+width-1)}if(typeof sEa=="number"&&sEa!=3&&sEa!=4&&(index+1)/width<20*(width-1)){adjacents.push(index+width+1)}let targetTile;let tileDistA=Math.sqrt(Math.pow(other.x-p.x,2)+Math.pow(other.y-p.y,2));let targetDist=1200;for(let a=0;a<8;a++){if(typeof adjacents[0]=="number"){let xB=32*(adjacents[a]%width)+16;let yB=32*(adjacents[a]/width>>0)+16;let tileDistB=Math.sqrt(Math.pow(other.x-xB,2)+Math.pow(other.y-yB,2));if(tileDistB<tileDistA&&tileDistB<targetDist){targetTile=adjacents[a];targetDist=tileDistB}}}if(targetTile){cpuTargets[i].x=32*(targetTile%width)+16;cpuTargets[i].y=32*(targetTile/width>>0)+16}else{cpuTargets[i].x=-1;cpuTargets[i].y=-1}}if(cpuTargets[i].x>-1&&cpuTargets[i].y>-1){let xDist=cpuTargets[i].x-p.x;let yDist=cpuTargets[i].y-p.y;let dist=Math.sqrt(Math.pow(xDist,2)+Math.pow(yDist,2));let rad=Math.atan2(yDist,xDist);if(rad<0){rad+=6.28}else if(rad>=6.28){rad-=6.28}let rDist=rad-p.r;if(rDist>3.14){turn=-1}else if(rDist<-3.14){turn=1}else if(rDist>.05){turn=1}else if(rDist<-.05){turn=-1}else{p.r=rad}if(turn){if(!gKeys[i].turn){gKeys[i].turn=turn}}else{if(gKeys[i].turn){gKeys[i].turn=0}if(!gKeys[i].move){gKeys[i].move=1}}}}break}if(turn){if(!gKeys[i].turn){gKeys[i].turn=turn}}else{if(gKeys[i].turn){gKeys[i].turn=0}}}}if(p.life<60){if(p.life>-30){p.life--}else{trails=[[],[]];if(round<roundLimit){shells=[];if(levelOption==RANDOM){levelNum=Math.random()*RANDOM>>0;level=LEVELS[levelNum];prerenderLevel(level,levelNum,score,++round,roundLimit);bubbles=generateBubbles(level,levelNum)}else{prerenderScore(score,++round,roundLimit)}if(players[0].treads){players[0].treads=stopSound(players[0].treads.o,players[0].treads.g)}if(players[1].treads){players[1].treads=stopSound(players[1].treads.o,players[1].treads.g)}if(players[0].turn){players[0].turn=stopSound(players[0].turn.o,players[0].turn.g)}if(players[1].turn){players[1].turn=stopSound(players[1].turn.o,players[1].turn.g)}players=[{x:64,y:64,r:0,life:60,delay:0,shells:0},{x:576,y:576,r:3.14,life:60,delay:0,shells:0}];gKeys[0]={};gKeys[1]={}}else{prerenderFinal(roundLimit,score);players[0].l=false;players[1].l=false;round=0;scene="final"}break}}else{let cell=level[getTileIndex(p.x,p.y,levelNum)];if(gKeys[i].turn){p.r+=gKeys[i].turn*.05;while(p.r<0){p.r+=6.28}while(p.r>6.28){p.r-=6.28}if(!players[i].turn){players[i].turn=startTurnSound(i)}}else if(players[i].turn){players[i].turn=stopSound(players[i].turn.o,players[i].turn.g)}if(gKeys[i].move){if(!players[i].treads){players[i].treads=startTreadsSound(i)}if(cell==5&&!players[i].l){players[i].l=true;trails[i]=[]}let cos=Math.cos(p.r);let sin=Math.sin(p.r);let speed=cell==2?1:2;let xPos=speed*gKeys[i].move*cos+p.x;let yPos=speed*gKeys[i].move*sin+p.y;let nextCell=level[getTileIndex(gKeys[i].move*16*cos+p.x,gKeys[i].move*16*sin+p.y,levelNum)];if(xPos<16){p.x=16}else if(levelNum>4&&xPos>784){p.x=784}else if(levelNum<5&&xPos>624){p.x=624}else if(nextCell<3||nextCell>4){p.x=xPos}if(yPos<16){p.y=16}else if(yPos>624){p.y=624}else if(nextCell<3||nextCell>4){p.y=yPos}}else if(players[i].treads){players[i].treads=stopSound(players[i].treads.o,players[i].treads.g)}if(gKeys[i].fire&&p.delay==0&&p.shells<3){p.delay=60;p.shells++;shells.push(new Shell(p,i));playFireSound(i)}let addTrail=true;let trailsLength=0;for(let t=0;t<8;t++){let trail=trails[i][t];if(addTrail){if(trail){let dist=Math.sqrt(Math.pow(p.x-trail.x,2)+Math.pow(p.y-trail.y,2));let radDiff=p.r-trail.r;if(dist<18&&radDiff>-1&&radDiff<1){addTrail=false}}}if(trail){trailsLength++}}if(addTrail){if(trailsLength==8){trails[i]=trails[i].slice(1)}trails[i].push({x:p.x,y:p.y,r:p.r})}if(p.delay>0){p.delay--}}}context.drawImage(prerender,0,0);if(levelOption>3){context.strokeStyle="#FE6";context.lineWidth=2;for(let i=0;i<400;i++){if(bubbles[i]){if(bubbles[i].step<90){context.beginPath();context.arc(bubbles[i].x+14,bubbles[i].y+10,5*(bubbles[i].step/90),0,6.28);context.stroke();context.closePath()}if(bubbles[i].step>=30){context.beginPath();context.arc(bubbles[i].x+8,bubbles[i].y+24,4*((bubbles[i].step-30)/90),0,6.28);context.stroke();context.closePath()}if(bubbles[i].step<30){context.beginPath();context.arc(bubbles[i].x+24,bubbles[i].y+20,4*((bubbles[i].step+60)/90),0,6.28);context.stroke();context.closePath()}else if(bubbles[i].step>=60){context.beginPath();context.arc(bubbles[i].x+24,bubbles[i].y+20,4*((bubbles[i].step-60)/90),0,6.28);context.stroke();context.closePath()}bubbles[i].step++;if(bubbles[i].step>120){bubbles[i].step=0}}else{break}}}for(let i=0;i<2;i++){let p=players[i];let xOffsets=[];let yOffsets=[];context.beginPath();context.strokeStyle=p.l?"rgba(223,32,16,0.75)":"rgba(32,16,0,0.6)";context.lineWidth=6;for(let t=0;t<8&&typeof trails[i][t]!=="undefined";t++){let trail=trails[i][t];xOffsets.push(6*Math.cos(trail.r+1.57));yOffsets.push(6*Math.sin(trail.r+1.57));context[t==0?"moveTo":"lineTo"](trail.x+xOffsets[t],trail.y+yOffsets[t])}context.lineTo(p.x+6*Math.cos(p.r+1.57),p.y+6*Math.sin(p.r+1.57));context.stroke();context.closePath();context.beginPath();for(let t=0;t<8&&typeof trails[i][t]!=="undefined";t++){let trail=trails[i][t];context[t==0?"moveTo":"lineTo"](trail.x-xOffsets[t],trail.y-yOffsets[t])}context.lineTo(p.x-6*Math.cos(p.r+1.57),p.y-6*Math.sin(p.r+1.57));context.stroke();context.closePath()}for(let i=0;i<2;i++){let p=players[i];let colors=playerColors[paletteOption];if(p.life==60){renderTank(context,p,colors[i])}else if(p.life>0){let r=(60-p.life)/3>>0;context.strokeStyle=colors[i];context.lineWidth=2;context.beginPath();context.moveTo(p.x+r/4,p.y);context.arc(p.x,p.y,r/4,0,6.28);if(p.life>5){context.moveTo(p.x+r/2,p.y);context.arc(p.x,p.y,r/2,0,6.28)}if(p.life>15){context.moveTo(p.x+r,p.y);context.arc(p.x,p.y,r,0,6.28)}context.stroke()}}let liveShells=[];for(let i=0;i<6&&typeof shells[i]!=="undefined";i++){let h=shells[i];if(moveShell(players,h,levelNum)){playRicochetSound(h.n)}context.fillStyle=players[h.n].l?"#FAA":"#FFE";context.fillRect(h.x-2,h.y-2,4,4)}for(let i=0;i<6&&typeof shells[i]!=="undefined";i++){let h=shells[i];for(let p=0;p<2;p++){if(shellCollidesWithPlayer(h,players[p])){if(players[i].treads){players[i].treads=stopSound(players[i].treads.o,players[i].treads.g)}if(players[i].turn){stopSound(players[i].turn.o,players[i].turn.g)}playExplodeSound(p);players[p].life--;score[p^1]++;h.life=0;prerenderScore(score,round,roundLimit)}}if(h.life>0){liveShells.push(h)}else{players[h.n].shells--}}shells=liveShells;break}if(!startTime){var startTime=timestamp}if(timestamp-startTime<2e3){window.requestAnimationFrame(step)}}window.requestAnimationFrame(step);var fontLoadInterval=setInterval(function(){prerenderTitle();let data=document.getElementById("pretext").getContext("2d").getImageData(0,0,942,640).data;for(let i=0;i<data.length;i+=4){if(data[i]){clearInterval(fontLoadInterval);scene="title";question.fillText("?",48,54);static=null;question=null;break}}},80);</script></html>
