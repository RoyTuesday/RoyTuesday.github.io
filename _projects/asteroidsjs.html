---
permalink: /projects/asteroids-js
---
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Asteroids JS</title>
    <script type="text/javascript">
      // Constants and global function declarations
      var MAX_ASTEROIDS = 7;
      var MAX_SPEED = 6;
      var ASTEROID_SPEED = 1;
      var VALID_KEYS = {
        'ArrowLeft' : 'Left Arrow',
        'ArrowRight': 'Right Arrow',
        'ArrowUp'   : 'Up Arrow',
        'ArrowDown' : 'Down Arrow',
        'PageUp'    : 'Page Up',
        'PageDown'  : 'Page Down',
        ' '         : 'Spacebar'
      }
      var DEFAULT_KEYS = {
        'left': 'ArrowLeft',
        'right': 'ArrowRight',
        'move': 'ArrowUp',
        'fire': ' '
      }
      var KEYS_BY_CODE = {
          8: 'Backspace',
          9: 'Tab',
         13: 'Enter',
         16: 'Shift',
         17: 'Control',
         18: 'Alt',
         32: ' ',
         33: 'PageUp',
         34: 'PageDown',
         35: 'End',
         36: 'Home',
         37: 'ArrowLeft',
         38: 'ArrowUp',
         39: 'ArrowRight',
         40: 'ArrowDown',
         45: 'Insert',
         46: 'Delete',
        186: ';',
        187: '=',
        188: ',',
        189: '-',
        190: '.',
        191: '/',
        192: '`',
        219: '[',
        220: '\\',
        221: ']',
        222: '\'',
      }
      for (var code in KEYS_BY_CODE) {
        if (KEYS_BY_CODE.hasOwnProperty(code) && ! VALID_KEYS[KEYS_BY_CODE[code]]) {
          VALID_KEYS[KEYS_BY_CODE[code]] = KEYS_BY_CODE[code];
        }
      }
      for (var i = 48; i < 90; i++) {
        var key = String.fromCharCode(i);
        if (! VALID_KEYS[key]) {
          VALID_KEYS[key] = key;
        }
      }

      var KEY_VALUES = {}
      for (var code in VALID_KEYS) {
        if (VALID_KEYS.hasOwnProperty(code)) {
          KEY_VALUES[VALID_KEYS[code]] = code;
        }
      }

      function preventEverything(event) {
        event.preventDefault();
        event.stopPropagation();
        return false;
      };

      function adaptAddEventListener(el, eventName, handler, options) {
        if (el.addEventListener) {
          el.addEventListener(eventName, handler, options);
        }
        else {
          function callHandler() { handler.call(el); }
          el.attachEvent('on' + eventName, callHandler);
          if (options.once) {
            setTimeout(function() {
              el.detachEvent('on' + eventName, callHandler);
            });
          }
        }
      }

      // Get's key in browsers with event.key and those without
      function getKey(event) {
        if (KEYS_BY_CODE[event.keyCode]) return KEYS_BY_CODE[event.keyCode];
        else if (/^\w$/.test(String.fromCharCode(event.keyCode))) return String.fromCharCode(event.keyCode);
        else if (event.key) return event.key.length === 1 ? event.key.toUpperCase() : event.key;
      }

      function ready(fun) {
        if (document.readyState != 'loading'){
          fun();
        }
        else if (document.addEventListener) {
          document.addEventListener('DOMContentLoaded', fun);
        }
        else {
          document.attachEvent('onreadystatechange', function() {
            if (document.readyState != 'loading')
              fun();
          });
        }
      }
    </script>
    <style media="screen">
      #main {
        background: #226;
        color: #FFF;
        font: 1rem monospace;
        text-align: center;
        position: fixed;
        top: 0;
        left: 0;
        margin: 0;
        padding: 0;
        max-width: 100vw;
        width: 100%;
        max-height: 100vh;
        height: 100%;
        box-sizing: border-box;
      }
      #wrapper {
        width: 1024px;
        height: 600px;
        transform-origin: top left;
      }
      #canvas {
        background: #000;
        display: inline-block;
        margin: 0;
        padding: 0;
        height: 600px;
        width: 800px;
      }
      aside {
        position: relative;
      	display: inline-block;
      	width: 200px;
        height: 576px;
      	padding: 12px;
        vertical-align: top;
      }
      #score-container {
        margin: 0 0 16px 0;
      }
      #input-container {
        display: block;
        width: 100%;
        margin: 12px 0;
      }
      .input-block {
        display: inline-block;
        width: 30%;
        margin: 0 auto;
      }
      .keybind {
        display: block;
        width: 100%;
        margin: 0;
      }
      label {
        display: block;
        text-shadow: -1px -1px 1px #777, 1px 1px 1px black;
      }
      #score-container label:first-child {
        margin-bottom: 10px;
      }
      #score-container label,
      #score-container .input-wrapper {
        display: inline-block;
        margin: 0 auto;
        vertical-align: top;
      }
      #score-container label {
        line-height: 29px;
        width: 45%;
      }
      #score-container .input-wrapper {
        width: 55%;
      }
      .input-wrapper {
        background: #000;
        width: 100%;
        padding: 4px;
        margin: 6px 0;
        box-sizing: border-box;
        overflow: hidden;
      }
      input {
        background: transparent;
        color: #FFF;
        font: 1rem monospace;
        border: none;
        width: 100%;
        box-sizing: border-box;
        transition: 230ms;
        text-align: center;
        box-sizing: border-box;
        box-shadow: 0 0 16px 0 rgba(255,255,255,0.5);
      }
      #input-container input:hover,
      #input-container input:focus,
      #keybinds-container input:hover,
      #keybinds-container input:focus {
        box-shadow: 0 0 16px 0 #FFF;
      }
      .button {
      	width: 120px;
      	height: 120px;
      	border-radius: 50%;
      	border: 4px solid;
        margin: 54px auto;
        position: relative;
        box-sizing: border-box;
        box-shadow: 2px 1px 0 2px black;
      }
      .button:after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border-radius: 50%;
        border: 3px solid;
        width: 85%;
        height: 85%;
        box-sizing: border-box;
      }
      .button:hover:after {
        border-width: 2px;
      }
      .button:active:after {
        border-width: 5px;
      }
      .button.button-red {
        background: radial-gradient(at 16px 16px, red 20%, #F77 80%);
        border-color: #F44;
      }
      .button.button-red:after {
        background: radial-gradient(at 80px 80px, red 20%, #F44 80%);
        border-color: #500;
      }
      .button.button-red:hover:after {
        background: radial-gradient(at 80px 80px, #F22 20%, #F55 80%);
      }
      .button.button-red:active:after {
        background: radial-gradient(at 60px 60px, #C00 20%, #D22 80%);
      }
      .button.button-yellow {
        background: radial-gradient(at 16px 16px, #DD0 20%, #FF7 80%);
        border-color: #FF4;
      }
      .button.button-yellow:after {
        background: radial-gradient(at 80px 80px, #DD0 20%, #FF4 80%);
        border-color: #550;
      }
      .button.button-yellow:hover:after {
        background: radial-gradient(at 80px 80px, #DD2 20%, #FF5 80%);
      }
      .button.button-yellow:active:after {
        background: radial-gradient(at 60px 60px, #CC0 20%, #DD2 80%);
      }
      #toggle-controls {
        background: radial-gradient(ellipse at bottom right, #777777 20%, #D7D7D7 80%);
        position: absolute;
        height: 38px;
        width: 200px;
        bottom: 0;
      }
      #toggle-controls:after {
        content: 'Toggle Controls';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 85%;
        height: 75%;
        background: transparent;
        border: 3px solid black;
        color: #111;
        padding: 3px;
        text-shadow: -1px -1px 0 #DDD;
        box-sizing: border-box;
        cursor: pointer;
      }
      #toggle-controls:active:after {
        background: radial-gradient(ellipse at bottom right, #707070 30%, #D0D0D0 90%);
        border-width: 4px;
        padding-top: 2px;
      }
      #toggle-controls.disabled {
        background: #777;
      }
      #toggle-controls.disabled:after {
        content: 'Mobile Only';
        border-color: #333;
        text-shadow: none;
      }
      #toggle-controls.disabled:active:after {
        background: transparent;
        border-width: 3px;
        padding-top: 3px;
      }
      .button,
      .small-screen,
      .orientation {
        display: none;
      }
      @media (max-width: 1024px) {
        .button {
          display: block;
        }
        #keybinds-container {
          display: none;
        }
      }
      @media (orientation: portrait) and (max-width: 480px) {
        #wrapper {
          display: none;
        }
        .orientation {
          display: block;
          color: #EEE;
          margin: 4em 1em;
        }
      }
      @media (orientation: landscape) and (max-width: 420px), (max-height: 310px) {
        #wrapper {
          display: none;
        }
        .small-screen {
          display: block;
          color: #EEE;
          margin: 4em 1em;
        }
      }
    </style>
  </head>
  <body>
    <div id="main">
      <div id="wrapper">
        <canvas id="canvas" width="800" height="600">
          Sorry, your browser does not meet the minimum requirements for this game
        </canvas><aside>
          <div id="score-container">
            <label for="score">Score</label><div class="input-wrapper"><input id="score" disabled="disabled"/></div>
            <label for="hiscore">Hi score</label><div class="input-wrapper"><input id="hiscore" disabled="disabled"/></div>
          </div>
          <div id="input-container">
            <div class="input-block"><label for="red">Red</label><div class="input-wrapper"><input data-color="r" name="red" value="255"/></div></div>
            <div class="input-block"><label for="green">Green</label><div class="input-wrapper"><input data-color="g" name="green" value="255"/></div></div>
            <div class="input-block"><label for="blue">Blue</label><div class="input-wrapper"><input data-color="b" name="blue" value="255"/></div></div>
          </div>
          <div id="keybinds-container">
            <div class="keybind">
              <label for="left">Turn Left</label>
              <div class="input-wrapper">
                <input type="text" name="left" value="">
              </div>
            </div>
            <div class="keybind">
              <label for="right">Turn Right</label>
              <div class="input-wrapper">
                <input type="text" name="right" value="">
              </div>
            </div>
            <div class="keybind">
              <label for="move">Fire Thrusters</label>
              <div class="input-wrapper">
                <input type="text" name="move" value="">
              </div>
            </div>
            <div class="keybind">
              <label for="fire">Fire Missile</label>
              <div class="input-wrapper">
                <input type="text" name="fire" value="">
              </div>
            </div>
          </div>
          <div id="button-red" class="button button-red"></div>
          <div id="button-yellow" class="button button-yellow"></div>
          <div id="toggle-controls"></div>
        </aside>
      </div>
      <div class="small-screen">
        Sorry, your screen is too small to play this game
      </div>
      <div class="orientation">
        Please rotate your device by one quarter turn
      </div>
    </div>

    <script type="text/javascript">
      ready(function() {
        var inputs = {
          'ArrowLeft': 'left',
          'ArrowRight': 'right',
          'ArrowUp': 'move',
          ' ': 'fire'
        }

        var scene = 'title';
        var score = 0;
        var buttonRed = document.getElementById('button-red');
        var buttonYellow = document.getElementById('button-yellow');
        var toggleControls = document.getElementById('toggle-controls');
        var keybinds = document.getElementById('keybinds-container');
        var buttons = document.getElementsByClassName('button');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        context.textAlign = 'center';
        context.fillStyle = '#FFF';
        context.strokeStyle = '#FFF';
        context.lineWidth = 1;

        var canvasScale = 1;
        adaptAddEventListener(window, 'resize', updateWrapper);
        function updateWrapper() {
          var scale = 1;
          var wrapper = document.getElementById('wrapper');
          if (window.innerWidth / window.innerHeight > 1024 / 600) {
            scale = window.innerHeight / 600;
          }
          else {
            scale = window.innerWidth / 1024;
          }
          canvasScale = Math.min(1, scale);
          wrapper.style.transform = 'scale(' + canvasScale + ')';
        }
        updateWrapper();

        function setToggleButton() {}

        adaptAddEventListener(toggleControls, 'contextmenu', preventEverything);
        adaptAddEventListener(toggleControls, 'touchstart', handleToggleControls);
        adaptAddEventListener(toggleControls, 'mousedown', disableToggleControls);
        adaptAddEventListener(toggleControls, 'mouseup', enableToggleControls);
        function handleToggleControls() {
          var keyDisp = keybinds.style.display ? keybinds.style.display : getComputedStyle(keybinds).display;
          var buttonDisp = buttons[0].style.display ? buttons[0].style.display : getComputedStyle(buttons[0]).display;

          keybinds.style.display = keyDisp === 'none' ? 'block' : 'none';
          for (var i = 0; i < buttons.length; i++) {
            buttons[i].style.display = buttonDisp === 'none' ? 'block' : 'none';
          }
        }
        function disableToggleControls(event) {
          var el = event.target;
          if (el.classList && el.classList.length === 0) {
            el.classList.add('disabled');
          }
          else if (el.className.length === 0 && ! el.className.includes('disabled')) el.className = 'disabled';
        }
        function enableToggleControls(event) {
          var el = event.target;
          if (el.classList && el.classList.length > 0) {
            el.classList.remove('disabled');
          }
          else if (el.className.includes('disabled')) el.className = '';
        }

        updateScore(true);
        document.getElementById('hiscore').value = Math.max(score, hiscore.value);
        function updateScore(reset) {
          if (reset) score = 0;
          else score++;
          document.getElementById('score').value = score;
        }

        var colorInputs = document.querySelectorAll('#input-container input');
        for (var i = 0; i < colorInputs.length; i++) {
          adaptAddEventListener(colorInputs[i], 'keyup', updateColor);
          updateColor({target: colorInputs[i]});
        }
        function updateColor(event) {
          var color, newColor;
          var colors = {
            r: parseInt(context.strokeStyle.substr(1,2), 16),
            g: parseInt(context.strokeStyle.substr(3,2), 16),
            b: parseInt(context.strokeStyle.substr(5,2), 16)
          }
          if (isNaN(event.target.value)) {
            event.target.value = colors[event.target.dataset.color];
          }
          else {
            if (event.target.value < 0 || event.target.value > 255 || event.target.value % 1 !== 0) {
              color = Math.max(0, Math.min(255, Math.round(event.target.value)));
              event.target.value = color;
            }
            else {
              color = event.target.value;
            }
            colors[event.target.dataset.color] = color;
            newColor = 'rgb(' + colors.r + ',' + colors.g + ',' + colors.b + ')';

            context.strokeStyle = newColor;
            context.fillStyle = newColor;
          }
        }

        var keybinds = document.querySelectorAll('#keybinds-container input');
        for (var i = 0; i < keybinds.length; i++) {
          adaptAddEventListener(keybinds[i], 'keydown', updateKeybinds);
          inputs[DEFAULT_KEYS[keybinds[i].name]] = keybinds[i].name;
          keybinds[i].value = VALID_KEYS[DEFAULT_KEYS[keybinds[i].name]];
        }
        function updateKeybinds(event) {
          event.preventDefault();
          var newInputs = {}
          var key = getKey(event);

          if (VALID_KEYS[key]) {
            newInputs[key] = event.target.name;
            event.target.value = VALID_KEYS[key];
          }
          else if (! event.target.value) {
            newInputs[DEFAULT_KEYS[event.target.name]] = event.target.name;
            event.target.value = VALID_KEYS[DEFAULT_KEYS[event.target.name]];
          }

          var others = document.querySelectorAll('#keybinds-container input:not([name="' + event.target.name + '"])');
          for (var i = 0; i < others.length; i++) {
            if (others[i].value === event.target.value) others[i].value = '';
            else newInputs[KEY_VALUES[others[i].value]] = others[i].name;
          }

          inputs = newInputs;
        }

        var Vector = function(rad, mag) {
          this.rad = typeof rad === 'number' ? rad : 0;
          this.mag = typeof mag === 'number' ? mag : 0;
          return this;
        }
        Vector.prototype.add = function(other) {
          var x = (this.mag * Math.cos(this.rad)) + (other.mag * Math.cos(other.rad));
          var y = (this.mag * Math.sin(this.rad)) + (other.mag * Math.sin(other.rad));
          this.rad = Math.atan2(y, x);
          this.mag = Math.min(MAX_SPEED, Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2)));
          return this;
        }

        function boundRads(rads) {
          return (2 * Math.PI + rads) % (2 * Math.PI);
        }

        var explosions = [];
        var Explosion = function(actor, end) {
          this.x = actor.x;
          this.y = actor.y;
          this.frame = 0;
          this.end = end ? end : 8;
          return this;
        }

        var Actor = function(x, y, vel, dir) {
          this.x = x;
          this.y = y;
          this.vel = vel;
          this.dir = dir ? dir : new Vector(vel.rad, 0);
          return this;
        }
        Actor.prototype.move = moveActor;
        function moveActor() {
          this.x += this.vel.mag * Math.cos(this.vel.rad);
          this.y += this.vel.mag * Math.sin(this.vel.rad);

          if (this.x < 0) this.x = canvas.width;
          else if (this.x > canvas.width) this.x = 0;

          if (this.y < 0) this.y = canvas.height;
          else if (this.y > canvas.height) this.y = 0;
        }

        var asteroids = [];
        while (asteroids.length < 3) spawnAsteroid();
        function spawnAsteroid(ast, rad) {
          var x, y, size;
          if (ast && rad) {
            x = ast.x + ((ast.dir.mag + 2) * Math.cos(rad));
            if (x < 0) x += canvas.width;
            else if (x > canvas.width) x -= canvas.width;

            y = ast.y + ((ast.dir.mag + 2) * Math.sin(rad));
            if (y < 0) y += canvas.height;
            else if (y > canvas.height) y -= canvas.height;

            size = ast.dir.mag - 16;
          }
          else {
            size = 16 * (Math.ceil(Math.random() * 3));
            var rad = Math.random() * (Math.PI * 2);
            var perimPoint = Math.random() * ((2 * canvas.width) + (2 * canvas.height));
            if (perimPoint < canvas.width) {
              x = perimPoint;
              y = 0;
            }
            else if (perimPoint < canvas.width + canvas.height) {
              x = canvas.width;
              y = perimPoint - canvas.width;
            }
            else if (perimPoint < (canvas.width * 2) + canvas.height) {
              x = perimPoint - (canvas.width + canvas.height);
              y = canvas.height;
            }
            else {
              x = 0;
              y = perimPoint - ((canvas.width * 2) + canvas.height);
            }
          }
          asteroids.push(new Actor(x, y, new Vector(rad, ASTEROID_SPEED), new Vector(Math.random() * (Math.PI * 2), size)));
        }

        var missile = false;
        var mTimeout = 0;
        var player;
        function setPlayer() {
          player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            vel: new Vector(),
            dir: new Vector(),
            size: 8,
            rot: 0,
            frame: 0,
            move: moveActor,
            setRot: function(dir) {
              this.rot = dir == 'right' ? Math.min(1, this.rot + 1) : Math.max(-1, this.rot - 1);
            }
          }
        }

        adaptAddEventListener(canvas, 'contextmenu', preventEverything);
        adaptAddEventListener(buttonRed, 'contextmenu', preventEverything);
        adaptAddEventListener(buttonYellow, 'contextmenu', preventEverything);
        // Touch events
        var touch = { x: 0, y: 0, active: false }
        adaptAddEventListener(canvas, 'touchstart', handleTouchDown);
        adaptAddEventListener(canvas, 'touchmove', handleTouchMove);
        adaptAddEventListener(canvas, 'touchend', handleTouchUp);
        adaptAddEventListener(canvas, 'touchcancel', handleTouchUp);
        // Touch event Handlers
        function handleTouchDown(event) {
          touch.active = true;
          handleTouchMove(event);
        }
        function handleTouchMove(event) {
          touch.x = event.touches[0].clientX * (1 / canvasScale);
          touch.y = event.touches[0].clientY * (1 / canvasScale);
        }
        function handleTouchUp(event) {
          touch.active = false;
          if (player) player.rot = 0;
        }
        // Key Events
        adaptAddEventListener(document, 'keydown', handleKeyDown);
        adaptAddEventListener(document, 'keyup', handleKeyUp);
        // Key event Handlers
        function handleKeyDown(event) {
          var key = getKey(event);
          if (event.target.tagName !== 'INPUT' && ! event.repeat && inputs[key]) {
            event.preventDefault();
            switch (inputs[key]) {
              case 'left': player.setRot('left'); break;
              case 'right': player.setRot('right'); break;
              case 'move': updateThrusters(true); break;
              case 'fire': handleFireAction(); break;
            }
          }
        }
        function handleKeyUp(event) {
          var key = getKey(event);
          if (event.target.tagName !== 'INPUT' && ! event.repeat && inputs[key]) {
            event.preventDefault();
            switch (inputs[key]) {
              case 'left': player.setRot('right'); break;
              case 'right': player.setRot('left'); break;
              case 'move': updateThrusters(); break;
            }
          }
        }
        // Touch Events
        adaptAddEventListener(buttonRed, 'touchstart', handleFireAction);
        adaptAddEventListener(buttonYellow, 'touchstart', handleYellowButton);
        adaptAddEventListener(buttonYellow, 'touchend', handleYellowButton);
        adaptAddEventListener(buttonYellow, 'touchcancel', handleYellowButton);
        // Touch event Handlers
        function handleFireAction(event) {
          if (scene !== 'game') reset();
          else {
            if (! missile) {
              missile = new Actor(player.x, player.y, new Vector(player.dir.rad, MAX_SPEED + 1));
              missile.life = 1000;
            }
          }
        }
        function handleYellowButton(event) {
          event.preventDefault();
          if (player) {
            updateThrusters(event.type === 'touchstart');
          }
        }
        function breakMissile() {
          missile = false;
          clearTimeout(mTimeout);
        }
        function updateThrusters(fireThrusters) {
          player.dir.mag = fireThrusters ? 1 : 0;
        }

        function reset() {
          setPlayer();
          updateScore(true);
          breakMissile();
          asteroids = [];
          while (asteroids.length < 3) spawnAsteroid();
          scene = 'game';
        }

        var updateInterval = window.setInterval(update, 20);
        function update() {
          if (missile) {
            missile.move();
            missile.life -= 20;
            if (missile.life <= 0) missile = false;
          }
          asteroids.forEach(function(ast) { ast.move() });
          handleCollisions();

          switch (scene) {
            case 'game':
              if (touch.active) {
                var diff = boundRads(Math.atan2(touch.y - player.y, touch.x - player.x)) - player.dir.rad;
                if (Math.abs(diff) > Math.PI) player.rot = diff > 0 ? -1 : 1;
                else if (Math.abs(diff) > 0.1) player.rot = diff > 0 ? 1 : -1;
                else player.rot = 0;
              }

              player.dir.rad = boundRads(player.dir.rad + (player.rot * (Math.PI / 24)));
              if (player.dir.mag > 0) {
                player.vel.add(player.dir);
              }
              player.frame = (player.frame + 1) % 6;
              player.move();
              break;
          }
        }
        function handleCollisions() {
          for (var i = 0; i < asteroids.length; i++) {
            if (scene == 'game' && detectActorCollision(player, asteroids[i])) {
              gameOver();
              return;
            }
            else if (missile && detectActorCollision(missile, asteroids[i])) {
              breakMissile();
              if (asteroids[i].dir.mag === 16) updateScore();
              breakAsteroid(i);
              asteroids.splice(i, 1);
              return;
            }
            else {
              for (var j = 0; j < asteroids.length; j++) {
                if (i !== j && detectActorCollision(asteroids[i], asteroids[j])) {
                  breakAsteroid(i);
                  breakAsteroid(j);
                  var newAsts = [];
                  asteroids.forEach(function(ast, index) {
                    if (index !== i && index !== j) newAsts.push(ast);
                  });
                  asteroids = newAsts;
                  return;
                }
              }
            }
          }
        }
        function detectActorCollision(actA, actB) {
          return Math.sqrt(Math.pow(Math.abs((actA.x + actA.dir.mag) - actB.x), 2) + Math.pow(Math.abs((actA.y + actA.dir.mag) - actB.y), 2)) < (actB.dir.mag + actA.dir.mag);
        }
        function breakAsteroid(index) {
          switch (asteroids[index].dir.mag) {
            case 48:
              spawnAsteroid(asteroids[index], asteroids[index].vel.rad + (Math.PI / 2));
              spawnAsteroid(asteroids[index], asteroids[index].vel.rad - (Math.PI / 2));
              break;
            case 32:
              spawnAsteroid(asteroids[index], asteroids[index].vel.rad + (Math.PI / 2));
              spawnAsteroid(asteroids[index], asteroids[index].vel.rad - (Math.PI / 2));
              break;
            default:
              explosions.push(new Explosion(asteroids[index]));
              break;
          }
          if (asteroids.length < MAX_ASTEROIDS) setTimeout(spawnAsteroid, 1000);
        }

        function render() {
          context.clearRect(0, 0, canvas.width, canvas.height);
          // Render missile
          if (missile) context.strokeRect(missile.x - 0.5, missile.y - 0.5, 1, 1);
          // Render asteroids
          asteroids.forEach(function(ast) {
            context.beginPath();
            context.moveTo(ast.x + (ast.dir.mag * (Math.cos(ast.dir.rad))), ast.y + (ast.dir.mag * (Math.sin(ast.dir.rad))));
            context.lineTo(ast.x + (ast.dir.mag * (Math.cos(ast.dir.rad - (Math.PI / 4)))), ast.y + (ast.dir.mag * (Math.sin(ast.dir.rad - (Math.PI / 4)))));
            context.lineTo(ast.x + ((ast.dir.mag * 0.8) * (Math.cos(ast.dir.rad - (Math.PI / 3)))), ast.y + ((ast.dir.mag * 0.8) * (Math.sin(ast.dir.rad - (Math.PI / 3)))));
            context.lineTo(ast.x + (ast.dir.mag * (Math.cos(ast.dir.rad - (Math.PI / 2)))), ast.y + (ast.dir.mag * (Math.sin(ast.dir.rad - (Math.PI / 2)))));
            context.lineTo(ast.x + (ast.dir.mag * (Math.cos(ast.dir.rad - (Math.PI * 3 / 4)))), ast.y + (ast.dir.mag * (Math.sin(ast.dir.rad - (Math.PI * 3 / 4)))));
            context.lineTo(ast.x - (ast.dir.mag * (Math.cos(ast.dir.rad))), ast.y - (ast.dir.mag * (Math.sin(ast.dir.rad))));
            context.lineTo(ast.x - (ast.dir.mag * (Math.cos(ast.dir.rad - (Math.PI / 4)))), ast.y - (ast.dir.mag * (Math.sin(ast.dir.rad - (Math.PI / 4)))));
            context.lineTo(ast.x - (ast.dir.mag * (Math.cos(ast.dir.rad - (Math.PI / 2)))), ast.y - (ast.dir.mag * (Math.sin(ast.dir.rad - (Math.PI / 2)))));
            context.lineTo(ast.x - ((ast.dir.mag * 1.1) * (Math.cos(ast.dir.rad - (Math.PI * 5 / 8)))), ast.y - ((ast.dir.mag * 1.1) * (Math.sin(ast.dir.rad - (Math.PI * 5 / 8)))));
            context.lineTo(ast.x - (ast.dir.mag * (Math.cos(ast.dir.rad - (Math.PI * 3 / 4)))), ast.y - (ast.dir.mag * (Math.sin(ast.dir.rad - (Math.PI * 3 / 4)))));
            context.closePath();
            context.stroke();

            // Debug render circle hitbox
            // context.strokeStyle = 'red';
            // context.beginPath();
            // context.moveTo(ast.x + ast.dir.mag, ast.y);
            // context.arc(ast.x, ast.y, ast.dir.mag, 0, Math.PI * 2);
            // context.closePath();
            // context.stroke();
            // context.strokeStyle = 'white';
          });

          switch(scene) {
            case 'title':
              context.font = '48px monospace';
              context.fillText('ASTEROIDS JS', canvas.width / 2, (canvas.height / 2) - 32);
              context.font = '18px monospace';
              context.fillText('Press "fire" to start', canvas.width / 2, (canvas.height / 2) + 8);
              break;
            case 'game':
              // Render player
              context.beginPath();
              context.moveTo(player.x + (16 * Math.cos(player.dir.rad)) + 0.5, player.y + (16 * Math.sin(player.dir.rad)) + 0.5);
              context.lineTo(player.x - (16 * Math.cos(player.dir.rad - (Math.PI / 5))) + 0.5, player.y - (16 * Math.sin(player.dir.rad - (Math.PI / 5))) + 0.5);
              context.lineTo(player.x - (8 * Math.cos(player.dir.rad)) + 0.5, player.y - (8 * Math.sin(player.dir.rad)) + 0.5);
              context.lineTo(player.x - (16 * Math.cos(player.dir.rad + (Math.PI / 5))) + 0.5, player.y - (16 * Math.sin(player.dir.rad + (Math.PI / 5))) + 0.5);
              context.closePath();
              context.stroke();
              // Render exhaust
              if (player.dir.mag !== 0) {
                var exMod = 24 + (3 * (player.frame < 3 ? player.frame : 6 - player.frame));
                context.beginPath();
                context.moveTo(player.x - (14 * Math.cos(player.dir.rad)) + 0.5, player.y - (14 * Math.sin(player.dir.rad)) + 0.5);
                context.lineTo(player.x - (18 * Math.cos(player.dir.rad - (Math.PI / 8))) + 0.5, player.y - (18 * Math.sin(player.dir.rad - (Math.PI / 8))) + 0.5);
                context.lineTo(player.x - (exMod * Math.cos(player.dir.rad)) + 0.5, player.y - (exMod * Math.sin(player.dir.rad)) + 0.5);
                context.lineTo(player.x - (18 * Math.cos(player.dir.rad + (Math.PI / 8))) + 0.5, player.y - (18 * Math.sin(player.dir.rad + (Math.PI / 8))) + 0.5);
                context.closePath();
                context.stroke();
              }
              break;
            case 'over':
              context.font = '64px monospace';
              context.fillText('GAME', canvas.width / 2, (canvas.height / 2) - 32);
              context.fillText('OVER', canvas.width / 2, (canvas.height / 2) + 32);
              break;
          }

          var newExp = [];
          explosions.forEach(function(exp) {
            context.beginPath();
            context.moveTo(exp.x + (exp.frame + 4), exp.y);
            context.arc(exp.x, exp.y, exp.frame + 4, 0, Math.PI * 2);
            context.closePath();
            context.stroke();
            // Increment the explosion's animation frame
            exp.frame++
            if (exp.frame < exp.end) newExp.push(exp);
          });
          explosions = newExp;
        }

        function gameOver() {
          scene = 'over';
          explosions.push(new Explosion(player, 12));
          document.getElementById('hiscore').value = Math.max(score, hiscore.value);
        }

        window.requestAnimationFrame(step);
        function step(timestamp) {
          if (! start) var start = timestamp;
          var progress = timestamp - start;

          render();

          if (progress < 2000) {
            window.requestAnimationFrame(step);
          }
        }
      });
    </script>
  </body>
</html>
